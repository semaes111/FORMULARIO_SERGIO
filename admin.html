<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta name="theme-color" content="#1B3A5C">
  <title>Panel — Generar Enlace Paciente</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@600;700&family=DM+Sans:wght@400;500;600&display=swap" rel="stylesheet">
  <style>
:root{--azul-profundo:#1B3A5C;--azul-medio:#2E6B9E;--azul-cielo:#5BA4D9;--azul-hielo:#D6E8F7;--metal-claro:#E8EEF4;--metal-medio:#C4D1DE;--metal-oscuro:#8A9BB0;--blanco-hielo:#F7F9FC;--blanco-puro:#FFFFFF;--gris-suave:#E2E8F0;--exito:#10B981;--error:#EF4444;--texto-principal:#1B3A5C;--texto-secundario:#5A7A9B;--shadow-raised:6px 6px 12px #B8C4D3,-4px -4px 8px #FFFFFF;--shadow-pressed:inset 3px 3px 6px #153050,inset -2px -2px 4px #3A7FBF;--shadow-card:0 4px 20px rgba(27,58,92,.08),0 1px 3px rgba(27,58,92,.06);--radius-md:12px;--radius-lg:16px;--radius-xl:24px}
*,*::before,*::after{margin:0;padding:0;box-sizing:border-box}
body{font-family:'DM Sans',sans-serif;background:var(--blanco-hielo);color:var(--texto-principal);min-height:100dvh;display:flex;align-items:center;justify-content:center;padding:20px}
.panel{max-width:440px;width:100%}
.panel-header{text-align:center;margin-bottom:28px}
.panel-logo{width:56px;height:56px;background:linear-gradient(135deg,var(--azul-medio),var(--azul-profundo));border-radius:var(--radius-md);display:flex;align-items:center;justify-content:center;margin:0 auto 16px}
.panel-logo svg{width:28px;height:28px;color:#fff}
.panel-header h1{font-family:'Plus Jakarta Sans',sans-serif;font-weight:700;font-size:22px;color:var(--azul-profundo)}
.panel-header p{font-size:14px;color:var(--texto-secundario);margin-top:4px}
.card{background:var(--blanco-puro);border-radius:var(--radius-lg);padding:28px 24px;box-shadow:var(--shadow-card);border:1px solid rgba(196,209,222,.25)}
.form-label{display:block;font-size:14px;font-weight:500;color:var(--texto-principal);margin-bottom:8px}
.form-label .required{color:var(--error);margin-left:2px}
.input-text{width:100%;height:48px;padding:14px 16px;font-family:'DM Sans',sans-serif;font-size:16px;color:var(--texto-principal);background:var(--blanco-puro);border:1.5px solid var(--metal-medio);border-radius:var(--radius-md);outline:none;transition:all .25s ease;margin-bottom:6px}
.input-text:focus{border-color:var(--azul-medio);box-shadow:0 0 0 3px rgba(46,107,158,.15)}
.input-hint{font-size:12px;color:var(--texto-secundario);margin-bottom:20px}
.btn-generate{width:100%;height:52px;border:none;border-radius:var(--radius-md);font-family:'DM Sans',sans-serif;font-size:16px;font-weight:600;cursor:pointer;display:flex;align-items:center;justify-content:center;gap:8px;background:linear-gradient(145deg,var(--azul-medio),var(--azul-profundo));color:#fff;box-shadow:0 4px 14px rgba(27,58,92,.3),4px 4px 10px #B8C4D3,-2px -2px 6px #FFF;transition:all .2s ease;-webkit-tap-highlight-color:transparent}
.btn-generate:active{transform:scale(.97);box-shadow:inset 2px 2px 4px rgba(0,0,0,.2)}
.btn-generate:disabled{opacity:.6;cursor:not-allowed;transform:none!important}
.btn-generate svg{width:20px;height:20px}
.btn-generate .spinner{display:none;width:20px;height:20px;border:3px solid rgba(255,255,255,.3);border-top-color:#fff;border-radius:50%;animation:spin .7s linear infinite}
.btn-generate.loading .btn-label{display:none}
.btn-generate.loading .spinner{display:block}
@keyframes spin{to{transform:rotate(360deg)}}

/* Result */
.result{display:none;margin-top:24px;animation:fadeIn .3s ease}
.result.visible{display:block}
@keyframes fadeIn{from{opacity:0;transform:translateY(8px)}to{opacity:1;transform:translateY(0)}}
.result-label{font-size:13px;font-weight:500;color:var(--texto-secundario);margin-bottom:8px;display:flex;align-items:center;gap:6px}
.result-label svg{width:14px;height:14px;color:var(--exito)}
.link-box{display:flex;gap:8px;align-items:center}
.link-input{flex:1;height:44px;padding:10px 12px;font-family:'DM Sans',sans-serif;font-size:13px;color:var(--azul-profundo);background:var(--azul-hielo);border:1.5px solid rgba(46,107,158,.2);border-radius:var(--radius-md);outline:none;overflow:hidden;text-overflow:ellipsis;white-space:nowrap}
.btn-copy{height:44px;padding:0 16px;border:none;border-radius:var(--radius-md);font-family:'DM Sans',sans-serif;font-size:14px;font-weight:600;cursor:pointer;display:flex;align-items:center;gap:6px;background:linear-gradient(145deg,#F0F4F8,#D1D9E6);box-shadow:4px 4px 8px #B8C4D3,-3px -3px 6px #FFF;color:var(--azul-profundo);transition:all .15s ease;-webkit-tap-highlight-color:transparent;white-space:nowrap}
.btn-copy:active{box-shadow:inset 2px 2px 4px #B8C4D3,inset -1px -1px 2px #FFF;transform:scale(.96)}
.btn-copy svg{width:16px;height:16px}
.btn-copy.copied{background:linear-gradient(145deg,var(--exito),#059669);color:#fff;box-shadow:0 2px 8px rgba(16,185,129,.3)}
.btn-whatsapp{width:100%;height:48px;margin-top:12px;border:none;border-radius:var(--radius-md);font-family:'DM Sans',sans-serif;font-size:15px;font-weight:600;cursor:pointer;display:flex;align-items:center;justify-content:center;gap:10px;background:#25D366;color:#fff;box-shadow:0 4px 12px rgba(37,211,102,.25);transition:all .2s ease;-webkit-tap-highlight-color:transparent}
.btn-whatsapp:active{transform:scale(.97)}
.btn-whatsapp svg{width:20px;height:20px}

/* History */
.section-divider{height:1px;background:var(--gris-suave);margin:28px 0 20px}
.history-title{font-size:14px;font-weight:600;color:var(--texto-principal);margin-bottom:14px;display:flex;align-items:center;gap:8px}
.history-title svg{width:18px;height:18px;color:var(--azul-medio)}
.history-list{display:flex;flex-direction:column;gap:10px;max-height:300px;overflow-y:auto}
.history-item{display:flex;align-items:center;justify-content:space-between;padding:12px 14px;border-radius:var(--radius-md);background:var(--blanco-hielo);border:1px solid var(--gris-suave)}
.history-name{font-size:14px;font-weight:500;color:var(--texto-principal)}
.history-meta{font-size:11px;color:var(--texto-secundario);margin-top:2px}
.history-badge{font-size:11px;font-weight:600;padding:4px 10px;border-radius:var(--radius-xl);white-space:nowrap}
.history-badge.pending{background:rgba(214,232,247,.5);color:var(--azul-medio)}
.history-badge.used{background:rgba(16,185,129,.1);color:#059669}
.history-badge.expired{background:rgba(239,68,68,.08);color:var(--error)}
.history-empty{text-align:center;padding:20px;font-size:13px;color:var(--texto-secundario)}
  </style>
</head>
<body>

<div class="panel">
  <div class="panel-header">
    <div class="panel-logo">
      <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M16 21v-2a4 4 0 0 0-4-4H6a4 4 0 0 0-4 4v2"/><circle cx="9" cy="7" r="4"/><line x1="19" y1="8" x2="19" y2="14"/><line x1="22" y1="11" x2="16" y2="11"/></svg>
    </div>
    <h1>Generar Enlace Paciente</h1>
    <p>Crea un enlace único para cada paciente</p>
  </div>

  <div class="card">
    <label class="form-label" for="patientName">Nombre y Apellidos del paciente <span class="required">*</span></label>
    <input type="text" class="input-text" id="patientName" placeholder="Ej: María García López" autocomplete="off" autocapitalize="words">
    <p class="input-hint">Este nombre aparecerá pre-rellenado en el formulario</p>

    <button type="button" class="btn-generate" id="btnGenerate" onclick="generateLink()">
      <span class="btn-label">
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M10 13a5 5 0 0 0 7.54.54l3-3a5 5 0 0 0-7.07-7.07l-1.72 1.71"/><path d="M14 11a5 5 0 0 0-7.54-.54l-3 3a5 5 0 0 0 7.07 7.07l1.71-1.71"/></svg>
        Generar enlace
      </span>
      <div class="spinner"></div>
    </button>

    <!-- RESULT -->
    <div class="result" id="result">
      <div class="result-label">
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5"><polyline points="20 6 9 17 4 12"/></svg>
        Enlace generado correctamente
      </div>
      <div class="link-box">
        <input type="text" class="link-input" id="linkOutput" readonly>
        <button type="button" class="btn-copy" id="btnCopy" onclick="copyLink()">
          <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect width="14" height="14" x="8" y="8" rx="2" ry="2"/><path d="M4 16c-1.1 0-2-.9-2-2V4c0-1.1.9-2 2-2h10c1.1 0 2 .9 2 2"/></svg>
          <span id="copyText">Copiar</span>
        </button>
      </div>
      <button type="button" class="btn-whatsapp" id="btnWhatsapp" onclick="sendWhatsApp()">
        <svg viewBox="0 0 24 24" fill="currentColor"><path d="M17.472 14.382c-.297-.149-1.758-.867-2.03-.967-.273-.099-.471-.148-.67.15-.197.297-.767.966-.94 1.164-.173.199-.347.223-.644.075-.297-.15-1.255-.463-2.39-1.475-.883-.788-1.48-1.761-1.653-2.059-.173-.297-.018-.458.13-.606.134-.133.298-.347.446-.52.149-.174.198-.298.298-.497.099-.198.05-.371-.025-.52-.075-.149-.669-1.612-.916-2.207-.242-.579-.487-.5-.669-.51-.173-.008-.371-.01-.57-.01-.198 0-.52.074-.792.372-.272.297-1.04 1.016-1.04 2.479 0 1.462 1.065 2.875 1.213 3.074.149.198 2.096 3.2 5.077 4.487.709.306 1.262.489 1.694.625.712.227 1.36.195 1.871.118.571-.085 1.758-.719 2.006-1.413.248-.694.248-1.289.173-1.413-.074-.124-.272-.198-.57-.347m-5.421 7.403h-.004a9.87 9.87 0 01-5.031-1.378l-.361-.214-3.741.982.998-3.648-.235-.374a9.86 9.86 0 01-1.51-5.26c.001-5.45 4.436-9.884 9.888-9.884 2.64 0 5.122 1.03 6.988 2.898a9.825 9.825 0 012.893 6.994c-.003 5.45-4.437 9.884-9.885 9.884m8.413-18.297A11.815 11.815 0 0012.05 0C5.495 0 .16 5.335.157 11.892c0 2.096.547 4.142 1.588 5.945L.057 24l6.305-1.654a11.882 11.882 0 005.683 1.448h.005c6.554 0 11.89-5.335 11.893-11.893a11.821 11.821 0 00-3.48-8.413z"/></svg>
        Enviar por WhatsApp
      </button>
    </div>

    <div class="section-divider"></div>

    <!-- HISTORY -->
    <div class="history-title">
      <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="10"/><polyline points="12 6 12 12 16 14"/></svg>
      Enlaces recientes
    </div>
    <div class="history-list" id="historyList">
      <div class="history-empty">Cargando...</div>
    </div>
  </div>
</div>

<script>
// ========================================
// CONFIG — CAMBIAR POR TUS DATOS
// ========================================
const SUPABASE_URL = 'https://bpazmmbjjducdmxgfoum.supabase.co';
const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImJwYXptbWJqamR1Y2RteGdmb3VtIiwicm9sZSI6ImFub24iLCJpYXQiOjE3Njc4MjY1MTksImV4cCI6MjA4MzQwMjUxOX0.uZd2m7JMXd_i-bZVsTQTcqTEhJMxLXwvdPLK74h07Kw';

// >>> CAMBIAR POR LA URL DONDE ALOJAS EL FORMULARIO <<<
const FORM_BASE_URL = 'https://formulario1.nexthorizont.ai';

let lastGeneratedLink = '';
let lastPatientName = '';

// ========================================
// SUPABASE REST HELPER
// ========================================
async function supabaseRequest(path, options = {}) {
  const url = `${SUPABASE_URL}/rest/v1/${path}`;
  const headers = {
    'apikey': SUPABASE_ANON_KEY,
    'Authorization': `Bearer ${SUPABASE_ANON_KEY}`,
    'Content-Type': 'application/json',
    'Prefer': options.prefer || 'return=representation',
    ...options.headers
  };
  const res = await fetch(url, { ...options, headers });
  if (!res.ok) {
    const err = await res.text();
    throw new Error(`Supabase error: ${res.status} — ${err}`);
  }
  return res.json();
}

// ========================================
// GENERATE LINK
// ========================================
async function generateLink() {
  const nameInput = document.getElementById('patientName');
  const name = nameInput.value.trim();
  if (name.length < 3) {
    nameInput.style.borderColor = 'var(--error)';
    nameInput.focus();
    return;
  }
  nameInput.style.borderColor = '';

  const btn = document.getElementById('btnGenerate');
  btn.classList.add('loading');
  btn.disabled = true;

  try {
    // INSERT into clinica_enlaces_pacientes (token is auto-generated by DB default)
    const data = await supabaseRequest('clinica_enlaces_pacientes', {
      method: 'POST',
      body: JSON.stringify({
        nombre_paciente: name
      })
    });

    const token = data[0].token;
    lastGeneratedLink = `${FORM_BASE_URL}?t=${token}`;
    lastPatientName = name;

    // Show result
    document.getElementById('linkOutput').value = lastGeneratedLink;
    document.getElementById('result').classList.add('visible');

    // Reset copy button
    const btnCopy = document.getElementById('btnCopy');
    btnCopy.classList.remove('copied');
    document.getElementById('copyText').textContent = 'Copiar';

    // Clear input
    nameInput.value = '';

    // Refresh history
    loadHistory();

  } catch (err) {
    console.error('Error generating link:', err);
    alert('Error al generar el enlace. Inténtelo de nuevo.');
  } finally {
    btn.classList.remove('loading');
    btn.disabled = false;
  }
}

// ========================================
// COPY LINK
// ========================================
async function copyLink() {
  try {
    await navigator.clipboard.writeText(lastGeneratedLink);
    const btn = document.getElementById('btnCopy');
    btn.classList.add('copied');
    document.getElementById('copyText').textContent = '¡Copiado!';
    setTimeout(() => {
      btn.classList.remove('copied');
      document.getElementById('copyText').textContent = 'Copiar';
    }, 2000);
  } catch {
    // Fallback
    const input = document.getElementById('linkOutput');
    input.select();
    document.execCommand('copy');
  }
}

// ========================================
// SEND WHATSAPP
// ========================================
function sendWhatsApp() {
  const message = encodeURIComponent(
    `Hola ${lastPatientName}, te enviamos el enlace para rellenar tus datos antes de la consulta:\n\n${lastGeneratedLink}\n\nTarda solo 3 minutos. ¡Gracias!`
  );
  window.open(`https://wa.me/?text=${message}`, '_blank');
}

// ========================================
// LOAD HISTORY
// ========================================
async function loadHistory() {
  const list = document.getElementById('historyList');
  try {
    const data = await supabaseRequest(
      'clinica_enlaces_pacientes?select=nombre_paciente,token,usado,expira_at,created_at&order=created_at.desc&limit=10'
    );

    if (data.length === 0) {
      list.innerHTML = '<div class="history-empty">No hay enlaces generados todavía</div>';
      return;
    }

    list.innerHTML = data.map(item => {
      const now = new Date();
      const expira = new Date(item.expira_at);
      const created = new Date(item.created_at);

      let badgeClass, badgeText;
      if (item.usado) {
        badgeClass = 'used';
        badgeText = 'Completado';
      } else if (expira < now) {
        badgeClass = 'expired';
        badgeText = 'Caducado';
      } else {
        badgeClass = 'pending';
        badgeText = 'Pendiente';
      }

      const timeAgo = getTimeAgo(created);

      return `
        <div class="history-item">
          <div>
            <div class="history-name">${escapeHtml(item.nombre_paciente || 'Sin nombre')}</div>
            <div class="history-meta">${timeAgo}</div>
          </div>
          <span class="history-badge ${badgeClass}">${badgeText}</span>
        </div>`;
    }).join('');

  } catch (err) {
    console.error('Error loading history:', err);
    list.innerHTML = '<div class="history-empty">Error al cargar el historial</div>';
  }
}

// ========================================
// HELPERS
// ========================================
function getTimeAgo(date) {
  const seconds = Math.floor((new Date() - date) / 1000);
  if (seconds < 60) return 'Hace un momento';
  const minutes = Math.floor(seconds / 60);
  if (minutes < 60) return `Hace ${minutes} min`;
  const hours = Math.floor(minutes / 60);
  if (hours < 24) return `Hace ${hours}h`;
  const days = Math.floor(hours / 24);
  return `Hace ${days} día${days > 1 ? 's' : ''}`;
}

function escapeHtml(str) {
  const div = document.createElement('div');
  div.textContent = str;
  return div.innerHTML;
}

// Enter to submit
document.getElementById('patientName').addEventListener('keypress', (e) => {
  if (e.key === 'Enter') generateLink();
});

// Init
document.addEventListener('DOMContentLoaded', loadHistory);
</script>
</body>
</html>
